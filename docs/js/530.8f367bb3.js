"use strict";(self["webpackChunkkwplayer"]=self["webpackChunkkwplayer"]||[]).push([[156,530],{2530:function(e,t,a){a.r(t),a.d(t,{OggContentError:function(){return E},OggParser:function(){return F}});a(8111),a(2489),a(1701);var s=a(7636),r=a(8968),i=a(4940),n=a(6351),o=a(4973),h=a(5775);class c extends((0,h.fO)("Opus")){}class g{constructor(e){if(e<19)throw new c("ID-header-page 0 should be at least 19 bytes long");this.len=e}get(e,t){return{magicSignature:new s.StringType(8,"ascii").get(e,t+0),version:s.UINT8.get(e,t+8),channelCount:s.UINT8.get(e,t+9),preSkip:s.UINT16_LE.get(e,t+10),inputSampleRate:s.UINT32_LE.get(e,t+12),outputGain:s.UINT16_LE.get(e,t+16),channelMapping:s.UINT8.get(e,t+18)}}}class m extends o._{constructor(e,t,a){super(e,t),this.idHeader=null,this.lastPos=-1,this.tokenizer=a,this.durationOnLastPage=!0}parseFirstPage(e,t){if(this.metadata.setFormat("codec","Opus"),this.idHeader=new g(t.length).get(t,0),"OpusHead"!==this.idHeader.magicSignature)throw new c("Illegal ogg/Opus magic-signature");this.metadata.setFormat("sampleRate",this.idHeader.inputSampleRate),this.metadata.setFormat("numberOfChannels",this.idHeader.channelCount),this.metadata.setAudioOnly()}async parseFullPage(e){const t=new s.StringType(8,"ascii").get(e,0);switch(t){case"OpusTags":await this.parseUserCommentList(e,8),this.lastPos=this.tokenizer.position-e.length;break;default:break}}calculateDuration(){if(this.lastPageHeader&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0){const e=this.lastPageHeader.absoluteGranulePosition-this.idHeader.preSkip;if(this.metadata.setFormat("numberOfSamples",e),this.metadata.setFormat("duration",e/48e3),-1!==this.lastPos&&this.tokenizer.fileInfo.size&&this.metadata.format.duration){const e=this.tokenizer.fileInfo.size-this.lastPos;this.metadata.setFormat("bitrate",8*e/this.metadata.format.duration)}}}}var d=a(1488);const l={len:80,get:(e,t)=>({speex:new s.StringType(8,"ascii").get(e,t+0),version:d.qW(new s.StringType(20,"ascii").get(e,t+8)),version_id:s.INT32_LE.get(e,t+28),header_size:s.INT32_LE.get(e,t+32),rate:s.INT32_LE.get(e,t+36),mode:s.INT32_LE.get(e,t+40),mode_bitstream_version:s.INT32_LE.get(e,t+44),nb_channels:s.INT32_LE.get(e,t+48),bitrate:s.INT32_LE.get(e,t+52),frame_size:s.INT32_LE.get(e,t+56),vbr:s.INT32_LE.get(e,t+60),frames_per_packet:s.INT32_LE.get(e,t+64),extra_headers:s.INT32_LE.get(e,t+68),reserved1:s.INT32_LE.get(e,t+72),reserved2:s.INT32_LE.get(e,t+76)})},p=i("music-metadata:parser:ogg:speex");class u extends o._{constructor(e,t,a){super(e,t)}parseFirstPage(e,t){p("First Ogg/Speex page");const a=l.get(t,0);this.metadata.setFormat("codec",`Speex ${a.version}`),this.metadata.setFormat("numberOfChannels",a.nb_channels),this.metadata.setFormat("sampleRate",a.rate),-1!==a.bitrate&&this.metadata.setFormat("bitrate",a.bitrate),this.metadata.setAudioOnly()}}const f={len:42,get:(e,t)=>({id:new s.StringType(7,"ascii").get(e,t),vmaj:s.UINT8.get(e,t+7),vmin:s.UINT8.get(e,t+8),vrev:s.UINT8.get(e,t+9),vmbw:s.UINT16_BE.get(e,t+10),vmbh:s.UINT16_BE.get(e,t+17),nombr:s.UINT24_BE.get(e,t+37),nqual:s.UINT8.get(e,t+40)})},T=i("music-metadata:parser:ogg:theora");class w{constructor(e,t,a){this.durationOnLastPage=!1,this.metadata=e}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}calculateDuration(){T("duration calculation not implemented")}async parseFirstPage(e,t){T("First Ogg/Theora page"),this.metadata.setFormat("codec","Theora");const a=f.get(t,0);this.metadata.setFormat("bitrate",a.nombr),this.metadata.setFormat("hasVideo",!0)}flush(){return Promise.resolve()}}a(6573),a(8100),a(7936);const I={len:27,get:(e,t)=>({capturePattern:new s.StringType(4,"latin1").get(e,t),version:s.UINT8.get(e,t+4),headerType:{continued:d.mh(e,t+5,0),firstPage:d.mh(e,t+5,1),lastPage:d.mh(e,t+5,2)},absoluteGranulePosition:Number(s.UINT64_LE.get(e,t+6)),streamSerialNumber:s.UINT32_LE.get(e,t+14),pageSequenceNo:s.UINT32_LE.get(e,t+18),pageChecksum:s.UINT32_LE.get(e,t+22),page_segments:s.UINT8.get(e,t+26)})};class P{static sum(e,t,a){const s=new DataView(e.buffer,0);let r=0;for(let i=t;i<t+a;++i)r+=s.getUint8(i);return r}constructor(e){this.len=e.page_segments}get(e,t){return{totalPageSize:P.sum(e,t,this.len)}}}var b=a(6254),y=a(6156),k=a(8442),N=a(3677);const S=i("music-metadata:parser:ogg:theora");class _{constructor(e,t,a){this.durationOnLastPage=!1,this.metadata=e,this.options=t,this.tokenizer=a,this.flacParser=new y.FlacParser(this.metadata,this.tokenizer,t)}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}calculateDuration(){S("duration calculation not implemented")}async parseFirstPage(e,t){S("First Ogg/FLAC page");const a=await k.e.get(t,9);if("fLaC"!==a.toString())throw new Error("Invalid FLAC preamble");const s=await b.Tw.get(t,13);await this.parseDataBlock(s,t.subarray(13+b.Tw.len))}async parseDataBlock(e,t){switch(S(`blockHeader type=${e.type}, length=${e.length}`),e.type){case b._B.STREAMINFO:{const e=b.om.get(t,0);return this.flacParser.processsStreamInfo(e)}case b._B.PADDING:break;case b._B.APPLICATION:break;case b._B.SEEKTABLE:break;case b._B.VORBIS_COMMENT:return this.flacParser.parseComment(t);case b._B.PICTURE:if(!this.options.skipCovers){const e=new N.xu(t.length).get(t,0);return this.flacParser.addPictureTag(e)}break;default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}flush(){return Promise.resolve()}}class E extends((0,h.fO)("Ogg")){}const U=i("music-metadata:parser:ogg");class C{constructor(e,t,a){this.pageNumber=0,this.closed=!1,this.metadata=e,this.streamSerial=t,this.options=a}async parsePage(e,t){this.pageNumber=t.pageSequenceNo,U("serial=%s page#=%s, Ogg.id=%s",t.streamSerialNumber,t.pageSequenceNo,t.capturePattern);const a=await e.readToken(new P(t));U("totalPageSize=%s",a.totalPageSize);const r=await e.readToken(new s.Uint8ArrayType(a.totalPageSize));if(U("firstPage=%s, lastPage=%s, continued=%s",t.headerType.firstPage,t.headerType.lastPage,t.headerType.continued),t.headerType.firstPage){this.metadata.setFormat("container","Ogg");const a=r.subarray(0,7),s=Array.from(a).filter(e=>e>=32&&e<=126).map(e=>String.fromCharCode(e)).join("");switch(s){case"vorbis":U(`Set Ogg stream serial ${t.streamSerialNumber}, codec=Vorbis`),this.pageConsumer=new o._(this.metadata,this.options);break;case"OpusHea":U("Set page consumer to Ogg/Opus"),this.pageConsumer=new m(this.metadata,this.options,e);break;case"Speex  ":U("Set page consumer to Ogg/Speex"),this.pageConsumer=new u(this.metadata,this.options,e);break;case"fishead":case"theora":U("Set page consumer to Ogg/Theora"),this.pageConsumer=new w(this.metadata,this.options,e);break;case"FLAC":U("Set page consumer to Vorbis"),this.pageConsumer=new _(this.metadata,this.options,e);break;default:throw new E(`Ogg codec not recognized (id=${s}`)}}if(t.headerType.lastPage&&(this.closed=!0),!this.pageConsumer)throw new Error("pageConsumer should be initialized");await this.pageConsumer.parsePage(t,r)}}class F extends n.s{constructor(){super(...arguments),this.streams=new Map}async parse(){let e;this.streams=new Map;try{do{if(e=await this.tokenizer.readToken(I),"OggS"!==e.capturePattern)throw new E("Invalid Ogg capture pattern");let t=this.streams.get(e.streamSerialNumber);if(t||(t=new C(this.metadata,e.streamSerialNumber,this.options),this.streams.set(e.streamSerialNumber,t)),await t.parsePage(this.tokenizer,e),t.pageNumber>12&&(!this.options.duration||![...this.streams.values()].find(e=>e.pageConsumer?.durationOnLastPage))){U("Stop processing Ogg stream");break}}while(![...this.streams.values()].every(e=>e.closed))}catch(t){if(t instanceof r.d1)U("Reached end-of-stream");else{if(!(t instanceof E))throw t;this.metadata.addWarning(`Corrupt Ogg content at ${this.tokenizer.position}`)}}for(const a of this.streams.values())a.closed||(this.metadata.addWarning(`End-of-stream reached before reaching last page in Ogg stream serial=${a.streamSerial}`),await(a.pageConsumer?.flush())),a.pageConsumer?.calculateDuration()}}},3677:function(e,t,a){a.d(t,{Sl:function(){return o},Z:function(){return n},xu:function(){return i}});a(6573),a(8100),a(7936),a(9577),a(4979);var s=a(7636),r=a(2272);class i{static fromBase64(e){return i.fromBuffer(Uint8Array.from(atob(e),e=>e.charCodeAt(0)))}static fromBuffer(e){const t=new i(e.length);return t.get(e,0)}constructor(e){this.len=e}get(e,t){const a=r.n5[s.UINT32_BE.get(e,t)];t+=4;const i=s.UINT32_BE.get(e,t);t+=4;const n=new s.StringType(i,"utf-8").get(e,t);t+=i;const o=s.UINT32_BE.get(e,t);t+=4;const h=new s.StringType(o,"utf-8").get(e,t);t+=o;const c=s.UINT32_BE.get(e,t);t+=4;const g=s.UINT32_BE.get(e,t);t+=4;const m=s.UINT32_BE.get(e,t);t+=4;const d=s.UINT32_BE.get(e,t);t+=4;const l=s.UINT32_BE.get(e,t);t+=4;const p=e.slice(t,t+l);return{type:a,format:n,description:h,width:c,height:g,colour_depth:m,indexed_color:d,data:p}}}const n={len:7,get:(e,t)=>({packetType:s.UINT8.get(e,t),vorbis:new s.StringType(6,"ascii").get(e,t+1)})},o={len:23,get:(e,t)=>({version:s.UINT32_LE.get(e,t+0),channelMode:s.UINT8.get(e,t+4),sampleRate:s.UINT32_LE.get(e,t+5),bitrateMax:s.UINT32_LE.get(e,t+9),bitrateNominal:s.UINT32_LE.get(e,t+13),bitrateMin:s.UINT32_LE.get(e,t+17)})}},4973:function(e,t,a){a.d(t,{_:function(){return g}});a(4114),a(6573),a(8100),a(7936),a(8111),a(7588),a(8237),a(9577),a(1549),a(9797),a(9631),a(5623);var s=a(7636),r=a(4940),i=a(9629),n=a(3677),o=a(5775);const h=r("music-metadata:parser:ogg:vorbis1");class c extends((0,o.fO)("Vorbis")){}class g{constructor(e,t){this.pageSegments=[],this.durationOnLastPage=!0,this.metadata=e,this.options=t}async parsePage(e,t){if(this.lastPageHeader=e,e.headerType.firstPage)this.parseFirstPage(e,t);else{if(e.headerType.continued){if(0===this.pageSegments.length)throw new c("Cannot continue on previous page");this.pageSegments.push(t)}if(e.headerType.lastPage||!e.headerType.continued){if(this.pageSegments.length>0){const e=g.mergeUint8Arrays(this.pageSegments);await this.parseFullPage(e)}this.pageSegments=e.headerType.lastPage?[]:[t]}}}static mergeUint8Arrays(e){const t=e.reduce((e,t)=>e+t.length,0),a=new Uint8Array(t);return e.forEach((e,t,s)=>{const r=s.slice(0,t).reduce((e,t)=>e+t.length,0);a.set(e,r)}),a}async flush(){await this.parseFullPage(g.mergeUint8Arrays(this.pageSegments))}async parseUserComment(e,t){const a=new i.Y(e,t),s=a.parseUserComment();return await this.addTag(s.key,s.value),s.len}async addTag(e,t){if("METADATA_BLOCK_PICTURE"===e&&"string"===typeof t){if(this.options.skipCovers)return void h("Ignore picture");t=n.xu.fromBase64(t),h(`Push picture: id=${e}, format=${t.format}`)}else h(`Push tag: id=${e}, value=${t}`);await this.metadata.addTag("vorbis",e,t)}calculateDuration(){this.lastPageHeader&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0&&(this.metadata.setFormat("numberOfSamples",this.lastPageHeader.absoluteGranulePosition),this.metadata.setFormat("duration",this.lastPageHeader.absoluteGranulePosition/this.metadata.format.sampleRate))}parseFirstPage(e,t){this.metadata.setFormat("codec","Vorbis I"),this.metadata.setFormat("hasAudio",!0),h("Parse first page");const a=n.Z.get(t,0);if("vorbis"!==a.vorbis)throw new c("Metadata does not look like Vorbis");if(1!==a.packetType)throw new c("First Ogg page should be type 1: the identification header");{const e=n.Sl.get(t,n.Z.len);this.metadata.setFormat("sampleRate",e.sampleRate),this.metadata.setFormat("bitrate",e.bitrateNominal),this.metadata.setFormat("numberOfChannels",e.channelMode),h("sample-rate=%s[hz], bitrate=%s[b/s], channel-mode=%s",e.sampleRate,e.bitrateNominal,e.channelMode)}}async parseFullPage(e){const t=n.Z.get(e,0);switch(h("Parse full page: type=%s, byteLength=%s",t.packetType,e.byteLength),t.packetType){case 3:return this.parseUserCommentList(e,n.Z.len);case 1:case 5:break}}async parseUserCommentList(e,t){const a=s.UINT32_LE.get(e,t);t+=4,t+=a;let r=s.UINT32_LE.get(e,t);t+=4;while(r-- >0)t+=await this.parseUserComment(e,t)}}},6156:function(e,t,a){a.r(t),a.d(t,{FlacParser:function(){return p}});a(8111),a(1701);var s=a(4940),r=a(7636),i=a(3677),n=a(7112),o=a(8442),h=a(4973),c=a(9629),g=a(5775),m=a(6254);const d=s("music-metadata:parser:FLAC");class l extends((0,g.fO)("FLAC")){}class p extends n.k{constructor(){super(...arguments),this.vorbisParser=new h._(this.metadata,this.options),this.padding=0}async postId3v2Parse(){const e=await this.tokenizer.readToken(o.e);if("fLaC"!==e.toString())throw new l("Invalid FLAC preamble");let t;do{t=await this.tokenizer.readToken(m.Tw),await this.parseDataBlock(t)}while(!t.lastBlock);if(this.tokenizer.fileInfo.size&&this.metadata.format.duration){const e=this.tokenizer.fileInfo.size-this.tokenizer.position;this.metadata.setFormat("bitrate",8*e/this.metadata.format.duration)}}async parseDataBlock(e){switch(d(`blockHeader type=${e.type}, length=${e.length}`),e.type){case m._B.STREAMINFO:return this.readBlockStreamInfo(e.length);case m._B.PADDING:this.padding+=e.length;break;case m._B.APPLICATION:break;case m._B.SEEKTABLE:break;case m._B.VORBIS_COMMENT:return this.readComment(e.length);case m._B.CUESHEET:break;case m._B.PICTURE:return void await this.parsePicture(e.length);default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}async readBlockStreamInfo(e){if(e!==m.om.len)throw new l("Unexpected block-stream-info length");const t=await this.tokenizer.readToken(m.om);this.metadata.setFormat("container","FLAC"),this.processsStreamInfo(t)}processsStreamInfo(e){this.metadata.setFormat("codec","FLAC"),this.metadata.setFormat("hasAudio",!0),this.metadata.setFormat("lossless",!0),this.metadata.setFormat("numberOfChannels",e.channels),this.metadata.setFormat("bitsPerSample",e.bitsPerSample),this.metadata.setFormat("sampleRate",e.sampleRate),e.totalSamples>0&&this.metadata.setFormat("duration",e.totalSamples/e.sampleRate)}async readComment(e){const t=await this.tokenizer.readToken(new r.Uint8ArrayType(e));return this.parseComment(t)}async parseComment(e){const t=new c.Y(e,0),a=t.readStringUtf8();a.length>0&&this.metadata.setFormat("tool",a);const s=t.readInt32(),r=new Array(s);for(let i=0;i<s;i++)r[i]=t.parseUserComment();await Promise.all(r.map(e=>("ENCODER"===e.key&&this.metadata.setFormat("tool",e.value),this.addTag(e.key,e.value))))}async parsePicture(e){return this.options.skipCovers?this.tokenizer.ignore(e):this.addPictureTag(await this.tokenizer.readToken(new i.xu(e)))}addPictureTag(e){return this.addTag("METADATA_BLOCK_PICTURE",e)}addTag(e,t){return this.vorbisParser.addTag(e,t)}}},6254:function(e,t,a){a.d(t,{Tw:function(){return n},_B:function(){return i},om:function(){return o}});var s=a(1488),r=a(7636);const i={STREAMINFO:0,PADDING:1,APPLICATION:2,SEEKTABLE:3,VORBIS_COMMENT:4,CUESHEET:5,PICTURE:6},n={len:4,get:(e,t)=>({lastBlock:s.mh(e,t,7),type:s.f5(e,t,1,7),length:r.UINT24_BE.get(e,t+1)})},o={len:34,get:(e,t)=>({minimumBlockSize:r.UINT16_BE.get(e,t),maximumBlockSize:r.UINT16_BE.get(e,t+2)/1e3,minimumFrameSize:r.UINT24_BE.get(e,t+4),maximumFrameSize:r.UINT24_BE.get(e,t+7),sampleRate:r.UINT24_BE.get(e,t+10)>>4,channels:s.f5(e,t+12,4,3)+1,bitsPerSample:s.f5(e,t+12,7,5)+1,totalSamples:s.f5(e,t+13,4,36),fileMD5:new r.Uint8ArrayType(16).get(e,t+18)})}},7112:function(e,t,a){a.d(t,{k:function(){return g}});var s=a(8968),r=a(4940),i=a(2272),n=a(9219),o=a(2898),h=a(6351);const c=r("music-metadata:parser:ID3");class g extends h.s{constructor(){super(...arguments),this.id3parser=new n.S}static async startsWithID3v2Header(e){return"ID3"===(await e.peekToken(i.yW)).fileIdentifier}async parse(){try{await this.parseID3v2()}catch(e){if(!(e instanceof s.d1))throw e;c("End-of-stream")}}finalize(){}async parseID3v2(){if(await this.tryReadId3v2Headers(),c("End of ID3v2 header, go to MPEG-parser: pos=%s",this.tokenizer.position),await this.postId3v2Parse(),this.options.skipPostHeaders&&this.metadata.hasAny())this.finalize();else{const e=new o.Bn(this.metadata,this.tokenizer,this.options);await e.parse(),this.finalize()}}async tryReadId3v2Headers(){const e=await this.tokenizer.peekToken(i.yW);if("ID3"===e.fileIdentifier)return c("Found ID3v2 header, pos=%s",this.tokenizer.position),await this.id3parser.parse(this.metadata,this.tokenizer,this.options),this.tryReadId3v2Headers()}}},9629:function(e,t,a){a.d(t,{Y:function(){return i}});var s=a(7636),r=a(4656);class i{constructor(e,t){this.data=e,this.offset=t}readInt32(){const e=s.UINT32_LE.get(this.data,this.offset);return this.offset+=4,e}readStringUtf8(){const e=this.readInt32(),t=(0,r.c)(this.data.subarray(this.offset,this.offset+e),"utf-8");return this.offset+=e,t}parseUserComment(){const e=this.offset,t=this.readStringUtf8(),a=t.indexOf("=");return{key:t.substring(0,a).toUpperCase(),value:t.substring(a+1),len:this.offset-e}}}}}]);
//# sourceMappingURL=530.8f367bb3.js.map